{% extends "base.html" %}

{% block title %}Game - Ride the Bus{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Game Header -->
    <div class="bg-green-800 rounded-lg p-4 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold">{{ game.phase.value.replace('_', ' ').title() }}</h2>
                {% if game.current_round %}
                <p class="text-green-300">Round: {{ game.current_round.value }}</p>
                {% endif %}
            </div>
            <div class="text-right">
                <p class="text-sm text-green-300">Room: {{ room_code }}</p>
                <p class="text-sm">Seed: {{ game.seed }}</p>
            </div>
        </div>
        
        <!-- Current Player Indicator -->
        {% if game.phase.value == 'phase_one_deal' %}
        <div class="mt-4 p-3 bg-green-700 rounded-lg">
            <p class="text-center">
                <span class="font-semibold">{{ game.players[game.current_player_index].name }}'s Turn</span>
                {% if game.current_round %}
                - {{ game.current_round.value }}: 
                {% if game.current_round.value == 'R1' %}Red or Black?{% endif %}
                {% if game.current_round.value == 'R2' %}Higher or Lower?{% endif %}
                {% if game.current_round.value == 'R3' %}Inside or Outside?{% endif %}
                {% if game.current_round.value == 'R4' %}Pick a Suit{% endif %}
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
    
    <!-- Game Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Main Game Area -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Phase One: Dealing -->
            {% if game.phase.value == 'phase_one_deal' %}
            <div class="bg-green-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Phase 1: The Deal</h3>
                
                <!-- Player's Hand -->
                <div class="mb-6">
                    <h4 class="font-medium mb-2">Your Cards</h4>
                    <div class="flex space-x-2">
                        {% for card in player.hand %}
                        <div class="card bg-white text-black rounded-lg p-2 w-16 h-20 flex flex-col items-center justify-center border shadow">
                            <div class="text-lg font-bold">{{ card.rank.value }}</div>
                            <div class="text-xl {% if card.suit.value in ['‚ô•', '‚ô¶'] %}text-red-500{% else %}text-black{% endif %}">
                                {{ card.suit.value }}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Empty slots -->
                        {% for i in range(4 - player.hand|length) %}
                        <div class="card-back bg-blue-900 rounded-lg p-2 w-16 h-20 flex items-center justify-center border-2 border-dashed border-green-600">
                            <span class="text-green-400">?</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Guess Buttons (only for current player) -->
                {% if game.players[game.current_player_index].id == player.id %}
                <div class="guess-controls">
                    {% if game.current_round.value == 'R1' %}
                    <div class="grid grid-cols-2 gap-4">
                        <button class="guess-btn bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-lg font-semibold" data-guess="red">
                            ‚ù§Ô∏è Red
                        </button>
                        <button class="guess-btn bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold" data-guess="black">
                            ‚ô†Ô∏è Black
                        </button>
                    </div>
                    {% elif game.current_round.value == 'R2' %}
                    <div class="grid grid-cols-2 gap-4">
                        <button class="guess-btn bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-lg font-semibold" data-guess="higher">
                            ‚¨ÜÔ∏è Higher
                        </button>
                        <button class="guess-btn bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold" data-guess="lower">
                            ‚¨áÔ∏è Lower
                        </button>
                    </div>
                    {% elif game.current_round.value == 'R3' %}
                    <div class="grid grid-cols-2 gap-4">
                        <button class="guess-btn bg-purple-600 hover:bg-purple-500 text-white px-6 py-3 rounded-lg font-semibold" data-guess="inside">
                            üìç Inside
                        </button>
                        <button class="guess-btn bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 rounded-lg font-semibold" data-guess="outside">
                            üåê Outside
                        </button>
                    </div>
                    {% elif game.current_round.value == 'R4' %}
                    <div class="grid grid-cols-2 gap-4">
                        <button class="guess-btn bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded-lg font-semibold" data-guess="hearts">
                            ‚ô•Ô∏è Hearts
                        </button>
                        <button class="guess-btn bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded-lg font-semibold" data-guess="diamonds">
                            ‚ô¶Ô∏è Diamonds
                        </button>
                        <button class="guess-btn bg-gray-800 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-semibold" data-guess="clubs">
                            ‚ô£Ô∏è Clubs
                        </button>
                        <button class="guess-btn bg-gray-800 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-semibold" data-guess="spades">
                            ‚ô†Ô∏è Spades
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center p-4 bg-green-700 rounded-lg">
                    <p class="text-green-300">Waiting for {{ game.players[game.current_player_index].name }} to make their guess...</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Phase Two: Pyramid -->
            {% if game.phase.value == 'phase_two_pyramid' %}
            <div class="bg-green-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Phase 2: The Pyramid</h3>
                
                <!-- Pyramid Grid -->
                <div class="pyramid-container flex flex-col items-center space-y-2 mb-6">
                    {% for row_idx in range(5) %}
                    <div class="pyramid-row flex space-x-2">
                        <span class="row-value w-8 h-8 bg-yellow-500 text-black rounded-full flex items-center justify-center font-bold text-sm">
                            {{ 5 - row_idx }}
                        </span>
                        {% for col_idx in range(5 - row_idx) %}
                        {% set cell = game.pyramid.rows[row_idx][col_idx] %}
                        <div class="pyramid-card w-16 h-20 rounded-lg border-2 flex flex-col items-center justify-center
                                   {% if cell.face_up %}bg-white text-black{% else %}bg-blue-900 border-green-600{% endif %}">
                            {% if cell.face_up and cell.card %}
                            <div class="text-lg font-bold">{{ cell.card.rank.value }}</div>
                            <div class="text-xl {% if cell.card.suit.value in ['‚ô•', '‚ô¶'] %}text-red-500{% else %}text-black{% endif %}">
                                {{ cell.card.suit.value }}
                            </div>
                            {% else %}
                            <span class="text-green-400">?</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Player Hand and Match Options -->
                <div>
                    <h4 class="font-medium mb-2">Your Remaining Cards</h4>
                    <div class="flex space-x-2 mb-4">
                        {% for card in player.hand %}
                        <div class="card bg-white text-black rounded-lg p-2 w-16 h-20 flex flex-col items-center justify-center border shadow cursor-pointer hover:ring-2 hover:ring-yellow-500"
                             data-card-id="{{ card.id }}">
                            <div class="text-lg font-bold">{{ card.rank.value }}</div>
                            <div class="text-xl {% if card.suit.value in ['‚ô•', '‚ô¶'] %}text-red-500{% else %}text-black{% endif %}">
                                {{ card.suit.value }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="flip-next-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold">
                            Flip Next Card
                        </button>
                        <button id="commit-match-btn" class="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold" disabled>
                            Commit Match
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Phase Three: Ride the Bus -->
            {% if game.phase.value == 'phase_three_bus' %}
            <div class="bg-green-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Phase 3: Ride the Bus</h3>
                
                {% set bus_rider = game.players|selectattr("is_bus_rider")|first %}
                <div class="text-center mb-6 p-4 bg-red-800 rounded-lg">
                    <h4 class="text-xl font-bold">üöå {{ bus_rider.name }} is riding the bus!</h4>
                    <p class="text-red-200">Face cards and Aces = drinks: J=1, Q=2, K=3, A=4</p>
                </div>
                
                <!-- Bus Cards -->
                <div class="bus-line flex space-x-2 justify-center mb-6">
                    {% for i in range(10) %}
                    {% if i < game.bus_cards|length %}
                    {% set card = game.bus_cards[i] %}
                    <div class="bus-card w-16 h-20 rounded-lg border-2 flex flex-col items-center justify-center
                               {% if i < game.bus_cursor %}bg-white text-black{% else %}bg-blue-900 border-green-600{% endif %}">
                        {% if i < game.bus_cursor %}
                        <div class="text-lg font-bold">{{ card.rank.value }}</div>
                        <div class="text-xl {% if card.suit.value in ['‚ô•', '‚ô¶'] %}text-red-500{% else %}text-black{% endif %}">
                            {{ card.suit.value }}
                        </div>
                        {% else %}
                        <span class="text-green-400">?</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                {% if game.bus_cursor < 10 %}
                <div class="text-center">
                    <button id="flip-bus-card-btn" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-lg font-semibold">
                        Flip Next Card ({{ game.bus_cursor + 1 }}/10)
                    </button>
                </div>
                {% else %}
                <div class="text-center p-4 bg-green-700 rounded-lg">
                    <h4 class="text-xl font-bold">üéâ Bus Complete!</h4>
                    <p>Total drinks for {{ bus_rider.name }}: {{ bus_rider.drinks_received }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
        </div>
        
        <!-- Sidebar -->
        <div class="space-y-6">
            
            <!-- Players Panel -->
            <div class="bg-green-800 rounded-lg p-4">
                <h3 class="font-semibold mb-3">Players</h3>
                <div class="space-y-2">
                    {% for p in game.players %}
                    <div class="player-card p-3 rounded-lg {% if p.id == player.id %}bg-yellow-700{% else %}bg-green-700{% endif %}
                                {% if game.phase.value == 'phase_one_deal' and loop.index0 == game.current_player_index %}ring-2 ring-yellow-400{% endif %}">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">{{ p.name }}{% if p.id == player.id %} (You){% endif %}</span>
                            {% if p.is_bus_rider %}
                            <span class="text-xs bg-red-600 px-2 py-1 rounded">BUS</span>
                            {% endif %}
                        </div>
                        <div class="text-xs text-green-200 mt-1">
                            Cards: {{ p.hand|length }} | Drinks: {{ p.drinks_received }}
                            {% if p.drinks_assigned > 0 %} | Assigned: {{ p.drinks_assigned }}{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Game Log -->
            <div class="bg-green-800 rounded-lg p-4">
                <h3 class="font-semibold mb-3">Game Log</h3>
                <div id="game-log" class="space-y-1 max-h-64 overflow-y-auto text-sm">
                    {% for entry in game.log[-10:] %}
                    <div class="log-entry p-2 bg-green-700 rounded text-xs">
                        <span class="text-green-300">{{ entry.t.strftime('%H:%M:%S') }}</span>
                        <span class="text-white">{{ entry.type.replace('_', ' ').title() }}</span>
                        {% if entry.by_player_id %}
                        {% set log_player = game.players|selectattr("id", "equalto", entry.by_player_id)|first %}
                        {% if log_player %}
                        <span class="text-yellow-300">- {{ log_player.name }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Game Stats -->
            <div class="bg-green-800 rounded-lg p-4">
                <h3 class="font-semibold mb-3">Stats</h3>
                <div class="text-sm space-y-1">
                    <div>Deck remaining: {{ game.deck|length }}</div>
                    <div>Discarded: {{ game.discard|length }}</div>
                    <div>Game seed: {{ game.seed }}</div>
                </div>
            </div>
            
        </div>
        
    </div>
</div>

<!-- Assignment Modal -->
<div id="assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white text-black rounded-lg max-w-md p-6 m-4">
        <h3 class="text-lg font-bold mb-4">Assign Drinks</h3>
        <p class="mb-4">You can assign <span id="drinks-to-assign">0</span> drinks.</p>
        
        <div class="space-y-3 mb-4">
            {% for p in game.players %}
            {% if p.id != player.id %}
            <label class="flex items-center justify-between p-2 border rounded">
                <span>{{ p.name }}</span>
                <input type="number" min="0" max="10" value="0" class="w-16 px-2 py-1 border rounded" data-player-id="{{ p.id }}">
            </label>
            {% endif %}
            {% endfor %}
        </div>
        
        <div class="flex space-x-4">
            <button id="confirm-assignment" class="flex-1 bg-blue-600 text-white py-2 rounded font-semibold">Confirm</button>
            <button id="cancel-assignment" class="flex-1 bg-gray-600 text-white py-2 rounded font-semibold">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    const gameId = '{{ game.id }}';
    const playerId = '{{ player.id }}';
    const roomCode = '{{ room_code }}';
    
    // Join room
    socket.emit('join', { room: roomCode });
    
    // Game state updates
    socket.on('game_update', (data) => {
        // Update UI based on game state changes
        console.log('Game update:', data);
        
        // For now, reload the page to show updated state
        // In a production app, you'd update the DOM directly
        setTimeout(() => location.reload(), 1000);
    });
    
    // Guess buttons
    document.querySelectorAll('.guess-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const guess = btn.dataset.guess;
            btn.disabled = true;
            
            try {
                const response = await fetch(`/api/make_guess/${gameId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guess })
                });
                
                const data = await response.json();
                if (response.ok) {
                    // Show result and update UI
                    showGuessResult(data);
                } else {
                    alert(data.error || 'Guess failed');
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error making guess:', error);
                alert('Network error');
                btn.disabled = false;
            }
        });
    });
    
    function showGuessResult(result) {
        const message = result.correct ? 
            `Correct! Drew ${result.card}` : 
            `Wrong! Drew ${result.card}. Penalty: ${result.penalty} drinks`;
        
        // Simple alert for now - in production, use a proper modal
        alert(message);
    }
    
    // Pyramid flip button
    const flipNextBtn = document.getElementById('flip-next-btn');
    if (flipNextBtn) {
        flipNextBtn.addEventListener('click', async () => {
            // API call to flip next pyramid card
            console.log('Flip next pyramid card');
        });
    }
    
    // Bus flip button
    const flipBusBtn = document.getElementById('flip-bus-card-btn');
    if (flipBusBtn) {
        flipBusBtn.addEventListener('click', async () => {
            // API call to flip next bus card
            console.log('Flip next bus card');
        });
    }
    
    // Auto-scroll game log
    const gameLog = document.getElementById('game-log');
    if (gameLog) {
        gameLog.scrollTop = gameLog.scrollHeight;
    }
</script>
{% endblock %}